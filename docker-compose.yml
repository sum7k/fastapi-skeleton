version: '3.8'

services:
  # ====================================
  # PostgreSQL Database
  # ====================================
  db:
    image: postgres:16-alpine
    container_name: fa-skeleton-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: fa_skeleton
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  # ====================================
  # Jaeger (OpenTelemetry Collector)
  # ====================================
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: fa-skeleton-jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      # OTLP HTTP receiver (for app traces) - can be overridden
      - "${JAEGER_OTLP_PORT:-4318}:4318"
      # Jaeger UI - can be overridden
      - "${JAEGER_UI_PORT:-16686}:16686"
      # OTLP gRPC receiver (optional)
      - "${JAEGER_GRPC_PORT:-4317}:4317"
    networks:
      - app-network

  # ====================================
  # FastAPI Application
  # ====================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fa-skeleton-app
    environment:
      # Database configuration (internal Docker network)
      DB_URL: postgresql+asyncpg://postgres:postgres@db:5432/fa_skeleton
      
      # JWT configuration
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-key-here-minimum-32-characters-long}
      
      # OpenTelemetry configuration (internal Docker network)
      OTLP_ENDPOINT: http://jaeger:4318
      SERVICE_NAME: fa-skeleton
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "${APP_PORT:-8002}:8000"
    depends_on:
      db:
        condition: service_healthy
      jaeger:
        condition: service_started
    volumes:
      # Mount code for development hot-reload (comment out for production)
      - ./:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - app-network

  # ====================================
  # Production App (Gunicorn + Uvicorn)
  # ====================================
  app-prod:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fa-skeleton-app-prod
    environment:
      DB_URL: postgresql+asyncpg://postgres:postgres@db:5432/fa_skeleton
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      OTLP_ENDPOINT: http://jaeger:4318
      SERVICE_NAME: fa-skeleton
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "${APP_PROD_PORT:-8001}:8000"
    depends_on:
      db:
        condition: service_healthy
    # Use Gunicorn with Uvicorn workers for production
    command: >
      sh -c "pip install gunicorn &&
             gunicorn main:app 
             --workers 4
             --worker-class uvicorn.workers.UvicornWorker
             --bind 0.0.0.0:8000
             --access-logfile -
             --error-logfile -
             --log-level info"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - app-network
    profiles:
      - production

volumes:
  postgres_data:
    driver: local

networks:
  app-network:
    driver: bridge
